var l=class o{data;size;constructor(t,n){this.data=t,this.size=n}static empty(){return o.withCapacity(4)}static withCapacity(t){let n=1<<32-Math.clz32(t-1),e=new Uint32Array(Math.max(n,4));return new o(e,0)}static zeros(t){let n=o.withCapacity(t);return n.size=t,n}static fromArray(t){let n=o.withCapacity(t.length);return n.data.set(t),n.size=t.length,n}get len(){return this.size}push(t){if(this.data.length===this.size){let n=this.data;this.data=new Uint32Array(this.data.length<<1),this.data.set(n)}this.data[this.len]=t,this.size+=1}pop(){return this.size===0?null:(this.size-=1,this.data[this.len])}get view(){return this.data.subarray(0,this.len)}};var f=class{values;refcount;index;freeIndices;constructor(t=[],n=l.empty()){if(this.values=t,this.refcount=n,this.index=new Map,this.freeIndices=l.empty(),t.length!==n.len)throw new Error("Length mismatch between values and refcount");for(let e=0;e<t.length;++e)n.view[e]>0?this.index.set(t[e],e):this.freeIndices.push(e)}add(t){let n=this.index.get(t);if(n===void 0){let e=this.freeIndices.pop();if(e===null){let r=this.values.length;return this.values.push(t),this.refcount.push(1),this.index.set(t,r),r}return this.values[e]=t,this.refcount.view[e]=1,this.index.set(t,e),e}return this.refcount.view[n]+=1,n}delete(t){let n=this.index.get(t);n!==void 0&&(this.refcount.view[n]-=1,this.refcount.view[n]<=0&&(this.index.delete(t),this.values[n]="",this.freeIndices.push(n)))}stringToIndex(t){return this.index.get(t)??null}indexToString(t){return this.values[t]}};var h=class o{data;constructor(t){this.data=t}static empty(){return new o(new Uint32Array(4))}add(t){let n=t>>5;if(this.data.length<=n){let s=this.data;this.data=new Uint32Array(1<<32-Math.clz32(n)),this.data.set(s)}let e=1<<(t&31),r=(this.data[n]&e)!==0;return this.data[n]|=e,r}delete(t){let n=t>>5;if(this.data.length<=n)return!1;let e=this.data[n]&1<<(t&31);return this.data[n]^=e,e!==0}count(){let t=0;for(let n of this.data){let e=n;e=e-(e>>1&1431655765),e=(e&858993459)+(e>>2&858993459),t+=(e+(e>>4)&252645135)*16843009>>24}return t}items(){let t=new Uint32Array(this.count()),n=0,e=0;for(let r of this.data){let s=r;for(;s;){let i=s&-s;s^=i,t[n]=31-Math.clz32(i)|e,n+=1}e+=32}return t}static union(t){if(t.length===0)return o.empty();let n=0;for(let r of t)n=Math.max(n,r.data.length);let e=new Uint32Array(n);for(let r of t)for(let s=0;s<r.data.length;++s)e[s]|=r.data[s];return new o(e)}static intersect(t){if(t.length===0)return o.empty();let n=-1>>>0,e=n;for(let s of t)e=Math.min(e,s.data.length);let r=new Uint32Array(e).fill(n);for(let s of t)for(let i=0;i<r.length;++i)r[i]&=s.data[i];return new o(r)}};function m(o){throw new Error("Unreachable code reached")}function w(o,t){if(t instanceof o)return t;throw new Error(`"${t}" is not of class "${o.name}"`)}var E=class{expireTime;heapPosition;constructor(t){this.expireTime=t,this.heapPosition=-1}},p=class{value;expiry;constructor(t){this.value=t,this.expiry=null}},y=class o{stringPool;data;heap;constructor(t=new f,n=new Array){this.stringPool=t,this.data=n,this.heap=l.empty();for(let e=0;e<n.length;++e)if(n[e].expiry!==null){let s=this.heap.len;this.heap.push(e),this.siftUp(s)}}getEntry(t){let n=this.stringPool.stringToIndex(t);if(n===null||n>=this.data.length)throw new Error("Key does not exists");return this.data[n]}addEntry(t){let n=this.stringPool.add(t);for(;this.data.length<=n;)this.data.push(new p(null));return this.data[n]}heapCmp(t,n){let e=this.data[t],r=this.data[n],s=e.expiry,i=r.expiry;if(s===null||i===null)throw new Error("Implementation error");return s.expireTime<i.expireTime}siftUp(t){let n=this.heap.view[t],e=t-1>>1,r=this.heap.view[e];for(;t>0&&!this.heapCmp(r,n);){this.heap.view[t]=r;let i=this.data[r].expiry;if(i===null)throw new Error("Implementation error");i.heapPosition=t,t=e,e=t-1>>1,r=this.heap.view[e]}this.heap.view[t]=n;let s=this.data[n].expiry;if(s===null)throw new Error("Implementation error");s.heapPosition=t}siftDown(t){let n=this.heap.view[t],e=t<<1|1;for(;e<this.heap.len;){let s=this.heap.view[e];if(e+1<this.heap.len){let a=this.heap.view[e+1];this.heapCmp(a,s)&&(e+=1,s=a)}if(this.heapCmp(n,s))break;this.heap.view[t]=s;let i=this.data[s].expiry;if(i===null)throw new Error("Implementation error");i.heapPosition=t,t=e,e=t<<1|1}this.heap.view[t]=n;let r=this.data[n].expiry;if(r===null)throw new Error("Implementation error");r.heapPosition=t}removeFromHeap(t){let n=this.heap.view[t],e=this.heap.pop();if(e===null)throw new Error("Implementation error");if(t<this.heap.len){this.heap.view[t]=e;let s=this.data[e];if(s.expiry===null)throw new Error("Implementation error");s.expiry.heapPosition=t,this.siftDown(t)}let r=this.data[n];r.expiry&&(r.expiry=null)}delete(t){let n=this.stringPool.stringToIndex(t);if(n===null||n>=this.data.length)return;let e=this.data[n],r=e.value;if(r!==null){if(e.value=null,e.expiry!==null&&this.removeFromHeap(e.expiry.heapPosition),this.stringPool.delete(t),typeof r=="number"){let s=this.stringPool.indexToString(r);this.stringPool.delete(s);return}if(r instanceof l){for(let s of r.view){let i=this.stringPool.indexToString(s);this.stringPool.delete(i)}return}if(r instanceof h){for(let s of r.items()){let i=this.stringPool.indexToString(s);this.stringPool.delete(i)}return}m(r)}}expireKey(t,n){this.clearExpired();let e=Date.now()/1e3+n,r=this.stringPool.stringToIndex(t);if(r===null||r>=this.data.length)throw new Error("Key does not exists");let s=this.data[r];if(s.expiry===null){let i=this.heap.len;s.expiry=new E(e),this.heap.push(r),this.siftUp(i)}else{let i=s.expiry.expireTime;s.expiry.expireTime=e,e<=i?this.siftUp(s.expiry.heapPosition):this.siftDown(s.expiry.heapPosition)}}clearExpired(){let t=Date.now()/1e3;for(;this.heap.len>0;){let n=this.heap.view[0],e=this.data[n].expiry;if(e===null)throw new Error("Implementation error");if(e.expireTime>t)break;let r=this.stringPool.indexToString(n);this.removeFromHeap(0),this.delete(r)}}setString(t,n){this.clearExpired();let e=this.addEntry(t);this.delete(t),e.value=this.stringPool.add(n)}getString(t){this.clearExpired();let e=this.getEntry(t).value;if(typeof e=="number")return this.stringPool.indexToString(e);throw new Error("Key holds a value that is not a string")}pushArray(t,n){this.clearExpired();let e=this.addEntry(t),r=e.value;if(r!==null){if(this.stringPool.delete(t),r instanceof l)for(let s of n)r.push(this.stringPool.add(s));else throw new Error("Key holds a value that is not a list");return}e.value=l.empty();for(let s of n)e.value.push(this.stringPool.add(s))}popArray(t){this.clearExpired();let e=this.getEntry(t).value;if(e instanceof l){let r=e.pop();if(r===null)return null;let s=this.stringPool.indexToString(r);return this.stringPool.delete(s),s}throw new Error("Key holds a value that is not a list")}sliceArray(t,n,e){this.clearExpired();let s=this.getEntry(t).value;if(s instanceof l){if(n<0||e>=s.len)throw new Error("Index out of bound");let i=e-n+1,a=new Array(i);for(let u=0;u<i;++u){let d=s.view[u+n];a[u]=this.stringPool.indexToString(d)}return a}throw new Error("Key holds a value that is not a list")}addSetItem(t,n){let e=this.stringPool.stringToIndex(t);e===null?n.add(this.stringPool.add(t)):n.add(e)||this.stringPool.add(t)}addSet(t,n){this.clearExpired();let e=this.addEntry(t),r=e.value;if(r!==null){if(this.stringPool.delete(t),r instanceof h)for(let s of n)this.addSetItem(s,r);else throw new Error("Key holds a value that is not a set");return}e.value=h.empty();for(let s of n)this.addSetItem(s,e.value)}removeSet(t,n){this.clearExpired();let r=this.getEntry(t).value;if(r instanceof h){for(let s of n){let i=this.stringPool.stringToIndex(s);i!==null&&r.delete(i)&&this.stringPool.delete(s)}return}throw new Error("Key holds a value that is not a set")}itemsToStrings(t){let n=new Array(t.length);for(let e=0;e<t.length;++e){let r=t[e];n[e]=this.stringPool.indexToString(r)}return n}getSet(t){this.clearExpired();let e=this.getEntry(t).value;if(e instanceof h){let r=e.items();return this.itemsToStrings(r)}throw new Error("Key holds a value that is not a set")}collectSets(t){let n=new Array(t.length);for(let e=0;e<t.length;++e){let r=t[e],i=this.getEntry(r).value;if(i instanceof h)n[e]=i;else throw new Error(`Key '${r}' holds a value that is not a set`)}return n}unionSet(t){this.clearExpired();let n=this.collectSets(t),e=h.union(n).items();return this.itemsToStrings(e)}intersectSet(t){this.clearExpired();let n=this.collectSets(t),e=h.intersect(n).items();return this.itemsToStrings(e)}keys(){this.clearExpired();let t=new Array;for(let n=0;n<this.data.length;++n)this.data[n].value!==null&&t.push(this.stringPool.indexToString(n));return t}ttl(t){this.clearExpired();let n=this.stringPool.stringToIndex(t);if(n===null||n>=this.data.length)return-2;let e=this.data[n],r=Date.now()/1e3;return e.expiry===null?-1:e.expiry.expireTime-r}serialize(){let t={stringPool:this.stringPool.values,data:[]};for(let n of this.data){let e=n.value,r=n.expiry?.expireTime;if(e===null){t.data.push({expireTime:r});continue}if(typeof e=="number"){t.data.push({value:{kind:"string",data:e},expireTime:r});continue}if(e instanceof l){t.data.push({value:{kind:"list",data:Array.from(e.view)},expireTime:r});continue}if(e instanceof h){t.data.push({value:{kind:"set",data:Array.from(e.items())},expireTime:r});continue}m(e)}return t}static deserialize({data:t,stringPool:n}){let e=l.zeros(n.length),r=new Array;for(let i=0;i<t.length;++i){let{value:a,expireTime:u}=t[i];if(a!==void 0){e.view[i]+=1;let d;switch(a.kind){case"string":d=new p(a.data),e.view[a.data]+=1;break;case"list":{let g=l.fromArray(a.data);for(let v of g.view)e.view[v]+=1;d=new p(g)}break;case"set":{let g=h.empty();for(let v of a.data)g.add(v)||(e.view[v]+=1);d=new p(g)}break;default:m(a)}u!==void 0&&(d.expiry=new E(u)),r.push(d)}else r.push(new p(null))}let s=new f(n,e);return new o(s,r)}};function I(o){let t=[],n="",e=!1,r=!1,s=!1;for(let i of o)r?(n+=i,r=!1):i==="\\"&&!r?r=!0:i==='"'?(e=!e,s=!0):` 	
\r\v\f`.includes(i)&&!e?(n.length>0||s)&&(t.push(n),n="",s=!1):n+=i;if((n.length>0||s)&&t.push(n),e||r)throw new Error("Unterminated string input");return t}function c(o,t,n){if(t>=o.length)throw new Error(`Parameter '${n}' not provided`);return o[t]}function k(o,t,n){let e=parseInt(c(o,t,n));if(isNaN(e))throw new Error(`Parameter '${n}' is not a number`);return e}var x=class{store=new y;async executeQuery(t){try{let n=I(t);if(n.length<1)return{kind:"error",message:"Empty query"};let e=n[0].toUpperCase(),r=n.slice(1);switch(e){case"SET":{let s=c(r,0,"key"),i=c(r,1,"value");return this.store.setString(s,i),{kind:"info",message:"OK"}}case"GET":{let s=c(r,0,"key");return{kind:"result",data:[this.store.getString(s)]}}case"RPUSH":{let s=c(r,0,"key"),i=r.slice(1);return this.store.pushArray(s,i),{kind:"info",message:"OK"}}case"RPOP":{let s=c(r,0,"key"),i=this.store.popArray(s);return i===null?{kind:"result",data:[]}:{kind:"result",data:[i]}}case"LRANGE":{let s=c(r,0,"key"),i=k(r,1,"start"),a=k(r,2,"end");return{kind:"result",data:this.store.sliceArray(s,i,a)}}case"SADD":{let s=c(r,0,"key"),i=r.slice(1);return this.store.addSet(s,i),{kind:"info",message:"OK"}}case"SREM":{let s=c(r,0,"key"),i=r.slice(1);return this.store.removeSet(s,i),{kind:"info",message:"OK"}}case"SMEMBERS":{let s=c(r,0,"key");return{kind:"result",data:this.store.getSet(s)}}case"SINTER":return{kind:"result",data:this.store.intersectSet(r)};case"SUNION":return{kind:"result",data:this.store.unionSet(r)};case"KEYS":return{kind:"result",data:this.store.keys()};case"DEL":{let s=c(r,0,"key");return this.store.delete(s),{kind:"info",message:"OK"}}case"EXPIRE":{let s=c(r,0,"key"),i=k(r,1,"seconds");return this.store.expireKey(s,i),{kind:"info",message:"OK"}}case"TTL":{let s=c(r,0,"key");return{kind:"result",data:[this.store.ttl(s).toFixed()]}}case"SAVE":{let s=this.store.serialize();return await this.save(JSON.stringify(s)),{kind:"info",message:"OK"}}case"RESTORE":{let s=await this.load();return this.store=y.deserialize(JSON.parse(s)),{kind:"info",message:"OK"}}default:return{kind:"error",message:`Unsupported command: ${e}`}}}catch(n){return n instanceof Error?{kind:"error",message:n.message}:{kind:"error",message:"An unknown error occurred"}}}};var S=class extends x{savedData=null;save(t){return this.savedData=t,Promise.resolve()}load(){return this.savedData===null?Promise.reject(new Error("No data has been saved to this context")):Promise.resolve(this.savedData)}},P=w(HTMLFormElement,document.getElementById("input-form")),T=w(HTMLInputElement,document.getElementById("input-query")),b=w(HTMLTemplateElement,document.getElementById("result-template")),A=document.getElementById("terminal"),K=new S;P.addEventListener("submit",o=>{let t=w(DocumentFragment,b.content.cloneNode(!0));t.querySelector(".result-query").textContent=T.value;let n=t.querySelector(".result"),e=t.querySelector(".result-body");A.appendChild(t),K.executeQuery(T.value).then(r=>{switch(r.kind){case"info":e.textContent=r.message;break;case"error":e.textContent=`ERROR: ${r.message}`;break;case"result":if(r.data.length===0)e.textContent="<empty>";else{let s=document.createElement("ol");for(let i of r.data){let a=document.createElement("li");a.textContent=i,s.appendChild(a)}e.appendChild(s)}break;default:m(r)}n.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})}),o.preventDefault(),P.reset()});
